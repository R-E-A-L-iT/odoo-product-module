<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Adds a unique ID to the portal sidebar -->
    <template id="sale_order_total" inherit_id="portal.portal_sidebar" priority="17">
        <xpath expr="//div" position="attributes">
            <attribute name="id">portalTotal</attribute>
        </xpath>
    </template>

    <!-- Adds a language notification banner for quotes -->
    <template id="sale_order_portal_notification" inherit_id="sale.sale_order_portal_content">
        <xpath expr="//div[@id='content']" position="before">
            <t t-if="sale_order.partner_id.lang == 'fr_CA' and request.lang.code in ('en_US', 'en_CA')">
                <div id="language-notification" class="alert alert-dismissible fade show" role="alert">
                    <h4 class="alert-heading">Préféreriez-vous voir cette quotation en français?</h4>
                    <a t-att-href="'/website/lang/fr_CA?r=' + sale_order.get_portal_url()" class="btn btn-primary">
                        Changer la langue
                    </a>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            </t>
        </xpath>
    </template>

    <!-- Sales Order Portal Content Customizations -->
    <template id="sale_order_portal_content" name="Sales Order Portal Content" inherit_id="sale.sale_order_portal_content" priority="17">
        <!-- Set the language of the sale order dynamically -->
        <xpath expr="//t[@t-set='sale_order']" position="replace">
            <t t-set="language" t-value="request.lang.code" />
            <t t-set="sale_order" t-value="sale_order.with_context(lang=language)" />
        </xpath>

        <!-- Display address block with dynamic header (image or video) -->
        <xpath expr="//div[@class='quote-address']" position="replace">
            <div class="quote-address">
                <img t-if="sale_order.header_id.url[-4:] == '.jpg'" alt="Header Img" t-att-src="sale_order.header_id.url" />
                <video t-if="sale_order.header_id.url[-4:] == '.mp4'" autoplay="true" loop="" t-att-src="sale_order.header_id.url"></video>
                <div class="quote-address-block">
                    <h1 class="title" t-field="sale_order.partner_id.parent_id.name or sale_order.partner_id.name" />
                    <div class="hr" />
                    <h2 class="subtitle">
                        <t t-field="sale_order.partner_id.street" />
                        <br />
                        <t t-if="sale_order.partner_id.city" t-out="sale_order.partner_id.city + ', '" />
                        <t t-field="sale_order.partner_id.state_id.code" />
                        <t t-field="sale_order.partner_id.zip" />
                        <t t-field="sale_order.partner_id.country_id.name" />
                    </h2>
                </div>
            </div>
        </xpath>

        <!-- Hide total section for rental quotes -->
        <xpath expr="//div[@id='total']" position="attributes">
            <attribute name="t-if">sale_order.is_rental != True</attribute>
        </xpath>

        <!-- Add custom quote sections -->
        <xpath expr="//table[@id='sales_order_table']/tbody" position="before">
            <!-- Hardware Section -->
            <t t-if="line.name == '$hardware'">
                <tr><td colspan="100"><t t-call="proquotes.renewal-hardware-english" /></td></tr>
            </t>
            <!-- Software Section -->
            <t t-elif="line.name == '$software'">
                <tr><td colspan="100"><t t-call="proquotes.renewal-software" /></td></tr>
            </t>
            <!-- Subscription Section -->
            <t t-elif="line.name == '$subscription'">
                <tr><td colspan="100"><t t-call="proquotes.renewal-subscription" /></td></tr>
            </t>
        </xpath>

        <!-- Add subtotal dynamically based on selected lines -->
        <xpath expr="//t[@t-set='current_subtotal']" position="replace">
            <t t-if="line.selected == 'true'">
                <t t-set="current_subtotal" t-value="current_subtotal + line.price_subtotal" />
            </t>
        </xpath>

        <!-- Rental terms and disclaimers -->
        <xpath expr="//section[@id='terms']" position="before">
            <div id="quote_disclaimer">
                <t t-if="language == 'en_CA' or language == 'en_US'">
                    <span>All prices in <t t-out="sale_order.currency_id.name" /> dollars.</span>
                </t>
                <t t-elif="language == 'fr_CA'">
                    <span>Tous les prix sont en dollars <t t-out="sale_order.currency_id.name" />.</span>
                </t>
            </div>
        </xpath>

        <!-- Custom Signature Section -->
        <xpath expr="//section[@id='signature']" position="replace">
            <section t-if="sale_order.signature" id="signature">
                <div class="text-center">
                    <h5>Signature</h5>
                    <img t-att-src="image_data_uri(sale_order.signature)" style="max-height: 6rem; max-width: 100%;" />
                    <p t-field="sale_order.signed_by" />
                </div>
            </section>
        </xpath>
    </template>

    <!-- Custom Portal Footer -->
    <template id="portal_footer" inherit_id="portal.portal_layout">
        <xpath expr="//div[@id='wrap']" position="after">
            <t t-call="custom.custom-footer" />
        </xpath>
    </template>
</odoo>
